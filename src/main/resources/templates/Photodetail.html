<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>在线医疗系统 </title>

    <!-- Bootstrap -->
    <link href="/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="/css/nprogress.css" rel="stylesheet">

    <!-- Custom Theme Style -->
    <link href="/css/custom.min.css" rel="stylesheet">
  </head>

  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col" th:include="fragment :: copy"></div>

       <!-- top navigation -->
       <div class="top_nav">
        <div class="nav_menu">
          <nav>
            <div class="nav toggle">
              <a id="menu_toggle"><i class="fa fa-bars"></i></a>
            </div>

            <ul class="nav navbar-nav navbar-right">
              <li class="">
                <a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                  <img src="/img/医生头像.jpg" alt="">医生
                  <span class=" fa fa-angle-down"></span>
                </a><!---->
                <ul class="dropdown-menu dropdown-usermenu pull-right">
                  <li><a href="／login.html"><i class="fa fa-sign-out pull-right"></i>退出登陆</a></li>
                </ul>
              </li>
            </ul>
          </nav>
        </div>
      </div>
      <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main">

          <div class="">
            
            <div class="clearfix"></div>

            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                  <div class="x_title">
                    <h2>照片详情</h2>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">

                    <div class="col-md-7 col-sm-7 col-xs-12" id="photoImage">
                    </div>
                    <br/><br/>

                    <div class="col-md-5 col-sm-5 col-xs-12" style="border:0px solid #e5e5e5;">

                      <h3 class="prod_title">选择分类标签</h3>
                      <br />
                      <form class="form-horizontal form-label-left">
                          <div class="form-group">
                              <label class="control-label col-md-3 col-sm-3 col-xs-12">一级分类</label>
                              <div class="col-md-9 col-sm-9 col-xs-12">
                                <select class="form-control" id="rootClassSelect">
                                </select>
                              </div>
                            </div>
                            <br />
                            <div class="form-group">
                                <label class="control-label col-md-3 col-sm-3 col-xs-12">二级分类</label>
                                <div class="col-md-9 col-sm-9 col-xs-12" >
                                  <select class="form-control" id="secondClassSelect">
                                  </select>
                                </div>
                              </div>
                              <br />
                          <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12">三级级分类</label>
                            <div class="col-md-9 col-sm-9 col-xs-12" >
                              <select class="form-control" id="thirdClassSelect">
                              </select>
                            </div>
                          </div>
                          <br />
                          <br />
                              <div class="col-md-9 col-sm-9 col-xs-12 col-md-offset-8">
                                  <button class="btn btn-round btn-primary" type="reset" id="submitSelect">添加分类</button>
                              </div>
                              
                      </form>
                      <div class="">
                        <br /><br />
                        <div class="ln_solid"></div>
                        <h2>现有标签</h2>
                        <br />
                        <ul class="list-inline prod_size" id="existTags">
                          <li>
                            <button type="button" class="btn btn-default btn-xs">寒热虚实</button>
                          </li>
                          <li>
                            <button type="button" class="btn btn-default btn-xs">阴虚</button>
                          </li>
                        </ul>
                      </div>
                      
                      <br />

                    </div>

                    <br />
                    <br />
                    <div class="col-md-12">
                        <div class="x_panel">
                            <div class="x_title">
                              <h2>医生回复</h2>
                              <div class="clearfix"></div>
                            </div>
                          <div id="doctorMessage">
                            <div class="x_content" >
                              <ul class="list-unstyled msg_list">
                                <li>
                                  <a>
                                    <span class="image">
                                      <img src="/img/医生头像.jpg" alt="img">
                                    </span>
                                    <span>
                                      <span>John Smith</span>
                                    </span>
                                    <span class="message">
                                      Film festivals used to be do-or-die moments for movie makers. They were where you met the producers that
                                    </span>
                                  </a>
                                </li>
                              </ul>
                            </div>
                          </div>

                            <label for="message"></label>
                            <label for="message">添加回复</label>
                            <textarea id="message" required="required" class="form-control" name="message" data-parsley-trigger="keyup" data-parsley-minlength="20" data-parsley-maxlength="100" data-parsley-minlength-message="Come on! You need to enter at least a 20 caracters long comment.." data-parsley-validation-threshold="10"></textarea>
                            <br />
                            <div class="col-md-9 col-sm-9 col-xs-12 col-md-offset-5">
                                <span class="btn btn-primary" id="submitReplay">添加回复</span>
                            </div>
                          </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- /page content -->

        <!-- footer content -->
        <footer>
          <div class="pull-right">
          </div>
          <div class="clearfix"></div>
        </footer>
        <!-- /footer content -->
      </div>
    </div>

    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>

    <script>
        var urlPath = window.location.href;
        var urlList = urlPath.split("/")
        var length = urlList.length
        var photoId = urlList[length-1]

        var photoDetailUrl = "/api/photo/"+photoId

        //ajax获取照片信息
      $.ajax({
          type : "get",
          url : photoDetailUrl,

          success : function(data, textStatus) {
//            插入照片
              var insertText = ""
              insertText += '<div class="product-image">'
              insertText +=   '<img id="mainPhoto" src="http://101.132.153.126:8080/shetai/shetai_image/'+data.positions[0]+'" alt="..." />'
              insertText += '</div>'
              insertText += '<div class="product_gallery">'
              $.each(data.positions,function (index,item){
                  insertText +=   '<a class="changePhoto" href="#">'
                  insertText +=     '<img src="http://101.132.153.126:8080/shetai/shetai_image/'+item+'" alt="..." />'
                  insertText +=   '</a>'

              })

              insertText += '</div>'
              $('#photoImage').html(insertText);

              changePhoto()



//            插入已有标签
              insertText = ""
              $.each(data.symptomTypeDetails,function (index,item){
                  insertText += '<li>'
                  insertText +=   '<button type="button" class="btn btn-default btn-xs">'
                  insertText +=     '一级分类：'+item.ppname+'二级分类：'+item.pname+'三级分类：'+item.tname
                  insertText +=   '</button>'
                  insertText += '</li>'
              })
//              if (data.childClassName != ""){
//                  insertText += '<li>'
//                  insertText +=   '<button type="button" class="btn btn-default btn-xs">'
//                  insertText +=     data.childClassName
//                  insertText +=   '</button>'
//                  insertText += '</li>'
//              }
//
              $('#existTags').html(insertText);



          }
      })
        //ajax获取医生回复信息
        var messageUrl = "/api/message/"+photoId

        //alert(messageUrl)
      $.ajax({
          type : "get",
          url : messageUrl,
          success : function(data, textStatus) {
              var insertText = ""
              $.each(data,function (index,item){
                  insertText += '<div class="x_content">'
                  insertText +=   '<ul class="list-unstyled msg_list">'
                  insertText +=     '<li>'
                  insertText +=     '<a>'
                  insertText +=       '<span class="image"><img src="/img/医生头像.jpg" alt="img"></span>'
                  insertText +=       '<span><span>'+item.senderName+' 医生</span></span>'
                  insertText +=       '<span class="message" style="font-size: 13px;">'
                  insertText +=         item.content
                  insertText +=       '</span>'
                  insertText +=     '</a>'
                  insertText +=     '</li>'
                  insertText +=   '</ul>'
                  insertText += '</div>'
              })

              $('#doctorMessage').html(insertText);
          }
      })

      //ajax获取分类信息
        var symptoms
        var subSymptoms
      $.ajax({
          type : "get",
          url : "/api/symptom/",
          success : function(data, textStatus) {
              insertText = ""
              symptoms = data
              $.each(data,function (index,item) {
                  insertText += '<option tagId="'+item.tid+'">'
                  insertText +=   item.tname
                  insertText += '</option>'
              })

              $('#rootClassSelect').html(insertText)
              bindChoose()
          }


      })
        //根分类下拉框监听
        function bindChoose() {
            $('#rootClassSelect').change(function(){
                var selectedTag = $(this).find("option:selected").attr('tagId')
                $.each(symptoms,function (index,item) {
                    if(item.tid == selectedTag){
                        subSymptoms = item
                        insertText = ""
                        $.each(item.subSymptomTypes,function (index,subItems){
                            insertText += '<option tagId="'+subItems.tid+'">'
                            insertText +=   subItems.tname
                            insertText += '</option>'
                        })

                    }
                })
                $('#secondClassSelect').html(insertText)
                bindSubChoose()
            })
        }
        //二级分类下拉框监听
        function bindSubChoose() {
            $('#secondClassSelect').change(function(){
                var selectedTag = $(this).find("option:selected").attr('tagId')
                //alert(selectedTag);
                $.each(subSymptoms.subSymptomTypes,function (index,item) {
                    if(item.tid == selectedTag){
                        insertText = ""
                        $.each(item.subSymptomTypes,function (index,subItems){
                            insertText += '<option tagId="'+subItems.tid+'">'
                            insertText +=   subItems.tname
                            insertText += '</option>'
                        })
                        $('#thirdClassSelect').html(insertText)

                    }

                })
            })
        }

        //添加分类
        $('#submitSelect').click(function(){
            var selectedTagId = $('#subClassSelect').find("option:selected").attr('tagId')
            var selectUrl = "/api/photo/"+photoId

            //alert(photoId)
            $.ajax({
                type : "put",
                url : selectUrl,
                data : {
                    tid :selectedTagId,

                },
                success : function(data, textStatus) {
                    location.reload()
                }
            })
        })

        //提交回复
      $('#submitReplay').click(function () {
          var text = $('#message').val()
          alert(text+photoId)
          $.ajax({
              type : "post",
              url : "/api/message",
              data : {
                  info : text,
                  pid : photoId,
                  success : function(data, textStatus) {
                      location.reload()
                  }
              }
          })
      })

      //切换照片
        function changePhoto() {
            $('.changePhoto').click(function(){
                var src = $(this).children().attr('src')
                //mainPhoto
                $('#mainPhoto').attr('src',src)

            })
        }

        changePhoto()
    </script>


    <!-- Bootstrap -->
    <script src="/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="/js/fastclick.js"></script>
    <!-- NProgress -->
    <script src="/js/nprogress.js"></script>

    <!-- Custom Theme Scripts -->
    <script src="/js/custom.min.js"></script>


  </body>
</html>